
### 当前进度（可直接衔接新对话）
- 已上线云函数：`get_product_ingredient_analyses_by_uid`
  - 用途：按 `uid` 查询 `product_ingredient_analysis` 历史记录，分页/排序。
  - 前端已封装：`src/services/cloudbaseService.js#getProductIngredientAnalysesByUid`，并新增 `getTempFileURLs` 处理图片临时链接。
- 前端对接
  - `src/views/ProductView.vue`：页面加载即拉取分析历史；将结果映射为 `ProductList` 的 `products`；点击卡片打开“分析详情”弹窗；修复图片 403（自动刷新临时 URL）。
  - `src/components/product/ProductList.vue`：支持 `openAnalysisDetail` 模式，卡片点击触发 `open-analysis` 事件；图片加载失败自动用 `fileId` 拉新临时 URL 重试。
  - 冲突检测 UI 已就绪（可多选、悬浮分析按钮、历史/详情弹窗），但后端冲突检测尚未实现。

### 关键代码位置
- 云函数目录：`cloudfunctions/get_product_ingredient_analyses_by_uid/`
- 前端服务：`src/services/cloudbaseService.js`
- 页面与组件：`src/views/ProductView.vue`、`src/components/product/ProductList.vue`

### “产品混用检测”云函数对接要点（建议）
- 函数名：`analyze_product_conflicts`（事件型）
- 入参
  - `productRecordIds`: string[]（至少 2 个，来自 `product_ingredient_analysis` 的 `_id`）
  - 可选：`uid`（优先在函数内 `app.auth().getUserInfo()` 获取并校验）
- 处理
  - 读取 `product_ingredient_analysis` 中对应记录，汇总每个产品的 `ingredients/analysis/productName/imageUrl/fileId`
  - 基于规则库/LLM完成冲突判定，生成冲突条目与建议
  - 写入历史集合：`product_conflicts`，结构见下
- 返回（需匹配现有 UI 结构）
  - `products`: `[ { _id, name, imageUrl, description? } ]`
  - `conflicts`: `[ { components: string[], severity: '高'|'中'|'低', description: string, effects?: string[] } ]`
  - `safeCombo`: `[ { components: string[], description: string } ]`
  - `recommendations`: `{ productPairings: { cannotUseTogether: [...], canUseTogether: [...] }, routines: { morning: string[], evening: string[] } }`
- 历史集合建议：`product_conflicts`
  - 字段：`{ uid, products: string[](产品名或记录ID), result: <同返回>, createdAt: Date }`
- 配套查询函数（供历史弹窗）
  - `get_product_conflict_history`（按 `uid` 分页）
  - `get_product_conflict_detail`（按 `conflictId` 返回完整 `result`）

### 前端改动点（待新对话实现）
- 在 `ProductView.vue#analyzeConflict` 中调用 `cloudbaseService` 新增的 `analyzeProductConflicts({ productRecordIds })`，使用 `selectedProductIds` 作为入参；成功后直接填充现有“冲突详情”弹窗数据结构并展示。
- 历史/详情弹窗目前指向本地 REST（`/api/conflicts/...`），改为调用对应云函数。

### 任务清单（最小闭环）
- 云函数
  - 实现 `analyze_product_conflicts`
  - 实现 `get_product_conflict_history`、`get_product_conflict_detail`
- 前端
  - 新增 `cloudbaseService.analyzeProductConflicts/getProductConflictHistory/getProductConflictDetail`
  - 改造 `ProductView.vue#analyzeConflict` 与历史/详情弹窗的数据来源

环境信息
- CloudBase 环境：`wuby-9gk84z40475927ab`（已用于现有云函数部署）
